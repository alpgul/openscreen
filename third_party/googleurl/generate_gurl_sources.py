#!/usr/bin/env python3
# Copyright 2025 The Chromium Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import os
import sys
import datetime

# Files that excluded from the build due to missing dependencies (e.g. base
# files that don't exist) or cause linker errors.
EXCLUDED_FILES = [
    "src/base/strings/sys_string_conversions_posix.cc",
    "src/url/origin.cc",
    "src/base/strings/abseil_string_number_conversions.cc",
    "src/base/strings/string_number_conversions.cc",
    "src/base/strings/safe_sprintf.cc",
    "src/base/strings/stringprintf.cc",
    "src/base/strings/to_string.cc",
    "src/url/gurl_debug.cc",
    "src/url/gurl_debug.h",
    "src/url/origin.h",
    "src/url/origin_debug.cc",
    "src/url/origin_debug.h",
    "src/url/scheme_host_port.cc",
    "src/url/scheme_host_port.h",
    "src/url/url_canon_icu.cc",
    "src/url/url_idna_icu.cc",
    "src/base/strings/string_split.cc",
    "src/base/strings/strcat.cc",
]


def get_chromium_header():
    """Returns the Chromium header for the current year."""
    current_year = datetime.date.today().year
    return (
        f"# Copyright {current_year} The Chromium Authors\n"
        f"# Use of this source code is governed by a BSD-style license that can be\n"
        f"# found in the LICENSE file.\n")


def get_rel_path(file_path, relative_to):
    """Returns the relative path in GN format for an absolute file path."""
    return os.path.relpath(file_path,
                           os.path.dirname(relative_to).replace('\\', '/'))


def main():
    """Generates a .gni file with a list of all .cc and .h files in src."""
    src_dir = os.path.join(os.path.dirname(__file__), 'src')
    gni_file = os.path.join(os.path.dirname(__file__), 'googleurl_sources.gni')
    sources = []

    # Currently, googleurl only has posix and win specific files. Other platforms
    # may be added here if support is needed.
    platform_specific_files = {
        'win': [],
        'posix': [],
    }
    for root, _, files in os.walk(src_dir):
        for f in files:
            file_path_full = os.path.join(root, f)
            rel_path_to_gni = os.path.relpath(
                file_path_full, os.path.dirname(gni_file)).replace('\\', '/')

            if (f.endswith('.cc') or f.endswith('.h')) and \
               'test' not in root and \
               'test' not in f and \
               not f.endswith('_unittest.cc') and \
               not f.endswith('_perftest.cc'):

                if rel_path_to_gni in EXCLUDED_FILES:
                    continue

                is_platform_specific = False
                for platform in platform_specific_files:
                    if f.endswith(f'_{platform}.cc') or f.endswith(
                            f'_{platform}.h'):
                        platform_specific_files[platform].append(
                            file_path_full)
                        is_platform_specific = True
                        break

                if not is_platform_specific:
                    sources.append(rel_path_to_gni)

    sources.sort()

    with open(gni_file, 'w') as f:
        f.write(get_chromium_header())
        f.write('#\n')
        f.write(
            '# This file is generated by generate_gurl_sources.py. Do not edit manually.\n'
        )
        f.write('\n')
        f.write('googleurl_sources = [\n')
        for source in sources:
            f.write('  "{}",\n'.format(source))
        f.write(']\n\n')

        for platform, files in platform_specific_files.items():
            declaration = f'googleurl_sources_{platform}'

            # We still want the prefix to be defined even if the length is zero.
            if not files:
                f.write(f'{declaration} = []\n')

            # Lists with only one entry should populate a single line.
            elif len(files) == 1:
                f.write(
                    f'{declaration} = [ "{get_rel_path(files[0], gni_file)}" ]\n'
                )

            # Multiple files, so do a standard list.
            else:
                files.sort()
                f.write(f'{declaration} = [\n')
                for file_path in files:
                    f.write(f'  "{get_rel_path(file_path, gni_file)}",\n')
                f.write(']\n\n')

    return 0


if __name__ == '__main__':
    sys.exit(main())
